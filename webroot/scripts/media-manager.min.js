function placeCaretAtEnd(e){if(e.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var i=document.createRange();i.selectNodeContents(e),i.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(i)}else if("undefined"!=typeof document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(e),a.collapse(!1),a.select()}}function editorHasFocus(e){var i,t,a;return document.selection?(i=document.selection.createRange(),i.collapse(e),i.parentElement()):(t=window.getSelection(),t.getRangeAt?t.rangeCount>0&&(i=t.getRangeAt(0)):(i=document.createRange(),i.setStart(t.anchorNode,t.anchorOffset),i.setEnd(t.focusNode,t.focusOffset),i.collapsed!==t.isCollapsed&&(i.setStart(t.focusNode,t.focusOffset),i.setEnd(t.anchorNode,t.anchorOffset))),i&&(a=i[e?"startContainer":"endContainer"],0!==$(a).parents(".html-editor").length)?!0:!1)}function insertHTMLAtCursor(e,i){var t,a;if(editorHasFocus()||placeCaretAtEnd($(".html-editor").get(0)),window.getSelection){if(t=window.getSelection(),t.getRangeAt&&t.rangeCount){a=t.getRangeAt(0),a.deleteContents();var l=document.createElement("div");l.innerHTML=e;for(var n=document.createDocumentFragment(),s,o;s=l.firstChild;)o=n.appendChild(s);var d=n.firstChild;a.insertNode(n),o&&(a=a.cloneRange(),a.setStartAfter(o),i?a.setStartBefore(d):a.collapse(!0),t.removeAllRanges(),t.addRange(a))}}else if((t=document.selection)&&"Control"!=t.type){var r=t.createRange();r.collapse(!0),t.createRange().pasteHTML(e),i&&(a=t.createRange(),a.setEndPoint("StartToStart",r),a.select())}}function addMarkdownSyntax(e){return void 0!==e?"!["+e.caption+"]("+UPLOAD_URL+e.name+' "'+e.caption+'")':void 0}function addHTMLSyntax(e){return void 0!==e?'<figure><img src="'+UPLOAD_URL+e.name+'" alt="'+e.caption+'"><figcaption>'+e.caption+"</figcaption></figure>":void 0}function getFileLibrary(){var e={editionId:$("input#EditionId").val()};$.ajax({url:SITE_URL+"/items/file_library",data:e,type:"POST",beforeSend:function(){$("#file-library").html("");var e={lines:10,length:5,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#666",speed:1.7,trail:80,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},i=document.getElementById("file-library"),t=new Spinner(e).spin();i.appendChild(t.el)}}).done(function(e){$("#file-library").fadeOut("fast",function(){fileList={},$("#insert-media").addClass("disabled"),$("#file-library").html(e),$(this).fadeIn("fast")})})}function mediaManager(){if($(".insert-media-btn").addClass("disabled"),$(document).on("focus",".html-editor",function(){$(".insert-media-btn").removeClass("disabled")}),0!==$("#media-manager").length){var e,i=new Array;$("#upload-files").hide(),$("#insert-media").addClass("disabled");var t=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"select-files",container:"file-uploader",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val()}});t.bind("Init",function(e,i){null!==i.runtime?$("#filelist #runtime-alert").remove():$("#filelist #files").remove()}),t.init(),t.bind("FilesAdded",function(e,i){for(var a in i){var l=i[a],n={fileId:l.id,fileName:l.name,fileSize:plupload.formatSize(l.size)};$.post(SITE_URL+"/items/file_item",n).done(function(e){$("#filelist ul#files").append(e)})}i.length&&$("#upload-files").fadeIn("fast"),$(document).on("click","#file-uploader .remove-file",function(e){var i=$(this).closest(".file").attr("id"),a=t.getFile(i);a&&$(".file#"+i).fadeOut("fast",function(){$(this).remove(),t.removeFile(a)})}),e.refresh()}),t.bind("Error",function(e,i){$("ul#files li#"+i.file.id).remove();var t=i.file?i.file.id:"",a=i.file?i.file.name:"",l={fileId:t,fileName:a,errorCode:i.code,errorMessage:i.message};$.post(SITE_URL+"/items/file_error",l).done(function(e){$("#filelist ul#files").append(e)}),e.refresh()}),t.bind("QueueChanged",function(e,i){0===e.files.length&&$("#upload-files").fadeOut("fast")}),t.bind("FileUploaded",function(e,i,t){$("ul#files li#"+i.id+" .remove-file i").removeClass("fa-times-circle").addClass("fa-check-circle").addClass("text-success"),$("ul#files li#"+i.id+" .remove-file").removeClass("remove-file").addClass("file-success"),$("ul#files li#"+i.id+" .progress").fadeOut("slow")}),t.bind("UploadComplete",function(e,t){$("#upload-files").fadeOut("fast"),"object"===$.type(i)&&(i=[]);for(var a in t){var l=t[a],l={name:l.name,caption:l.name};if(0!==$(".html-editor:visible").length)var n=addHTMLSyntax(l);else var n=addMarkdownSyntax(l);i.push(n)}$("#insert-media").removeClass("disabled")}),t.bind("UploadProgress",function(e,i){$("#filelist ul#files li#"+i.id+" span.progress-bar").width(i.percent+"%").attr("aria-valuenow",i.percent)}),$("#upload-files").on("click",function(e){t.start(),e.preventDefault()}),$("#insert-media").on("click",function(e){if(void 0===i[0]){var t=[];for(var a in i){var l=i[a];if(0!==$(".html-editor:visible").length)var l=addHTMLSyntax(l);else var l=addMarkdownSyntax(l);t.push(l)}var n=t.join("\n")+"\n"}else var n=i.join("\n")+"\n";0!==$(".html-editor:visible").length?insertHTMLAtCursor(n,!1):$("textarea.text-editor:visible").insertAtCaret(n),$("#media-manager").modal("hide"),$(".modal-toggles a").removeClass("disabled")}),$("#media-manager .btn-group a").on("click",function(e){$(this).hasClass("disabled")||($("#media-manager .btn-group a").toggleClass("disabled"),$("#file-uploader, #file-library").toggle(),"toggle-file-library"===$(this).attr("id")?getFileLibrary():$("#insert-media").addClass("disabled")),e.preventDefault()}),$(document).on("click","#file-library a.thumbnail",function(e){var t=$(this).attr("id");if($(e.target).closest(".delete-file").length>0){var a=$(this),l=a.attr("id").substr(5),n={fileId:l,editionId:$("input#EditionId").val()};$.post(SITE_URL+"/items/file_delete",n).done(function(e){a.remove(),null!==i[t]&&delete i[t]})}else if($(e.target).closest(".file-caption").length>0){var s=$(e.target).parents(".thumbnail").attr("id").substr(5),o=$("#file-caption-"+s);o.toggleClass("hidden"),$("#modal-overlay").toggleClass("hidden")}else{if($(this).toggleClass("selected"),$(this).hasClass("selected")){var d={name:$("img",this).attr("data-filename"),caption:$("img",this).attr("alt")};i[t]=d}else null!==i[t]&&delete i[t];void 0!==i&&($.isEmptyObject(i)?$("#insert-media").addClass("disabled"):$("#insert-media").removeClass("disabled"))}e.preventDefault()}),$(document).on("click",".file-caption-form button.close, #modal-overlay",function(e){if(!$(this).hasClass("clicked")){$(this).addClass("clicked");var i=$(".file-caption-form:visible input.file-id").val(),t=$(".file-caption-form:visible textarea").val(),a={fileId:i,editionId:$("input#EditionId").val(),caption:t};$(".file-caption-form:visible").toggleClass("hidden"),$.post(SITE_URL+"/items/file_caption",a).done(function(e){$("#modal-overlay").toggleClass("hidden")})}e.preventDefault()}),$("#media-manager").on("hidden.bs.modal",function(){t.files=[],$("#upload-files").hide(),$("ul#files li").remove(),t.refresh(),i=[],$("#file-library a.thumbnail").removeClass("selected"),$(".modal-toggles a").removeClass("disabled"),0!==$(".html-editor:visible").length&&$(".rich-text-processor").addClass("disabled")}),$("#media-manager").on("show.bs.modal",function(){$("#file-uploader").hide(),getFileLibrary()})}}function coverUploader(){var e=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"cover-image-upload",container:"cover-uploader",drop_element:"cover-image-upload",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val(),type:"cover"}});e.init(),e.bind("FilesAdded",function(e,i){e.start()}),e.bind("UploadComplete",function(e,i){$("#cover-image-upload span.fa-plus").show(""),$("#cover-image-upload .spinner").remove("");var t=$("input#EditionId").val();$.get(SITE_URL+"/editions/get_cover/"+t).done(function(e){$("#cover-image-current").css({"background-image":'url("'+UPLOAD_URL+e+'")'})})}),e.bind("BeforeUpload",function(e,i){var t={lines:11,length:6,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#333",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};$("#cover-image-upload span.fa-plus").hide("");var a=document.getElementById("cover-image-upload"),l=new Spinner(t).spin(a)})}function stylePackageUploader(){var e=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"edition-style-upload",container:"edition-style-select-group",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val(),"package":!0}});e.init(),e.bind("FilesAdded",function(e,i){e.start()}),e.bind("UploadComplete",function(e,i){$("#edition-style-upload").removeClass("disabled"),$("#edition-style-upload span.fa-spinner").removeClass("fa-spinner").removeClass("fa-spin").addClass("fa-cloud-upload");var t=i[0].name,a=t.substr(0,t.lastIndexOf(".zip"));$("#EditionStyle").append('<option name="'+i[0].name+'">'+a+"</option>")}),e.bind("BeforeUpload",function(e,i){$("#edition-style-upload").addClass("disabled"),$("#edition-style-upload span.fa-cloud-upload").removeClass("fa-cloud-upload").addClass("fa-spinner").addClass("fa-spin")})}$(document).ready(function(){mediaManager(),coverUploader(),stylePackageUploader(),$("body").tooltip({selector:"[data-toggle=tooltip]"})});