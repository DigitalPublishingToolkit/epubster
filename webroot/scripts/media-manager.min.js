function insertHTMLAtCursor(e,i){var a,l;if(window.getSelection){if(a=window.getSelection(),a.getRangeAt&&a.rangeCount){l=a.getRangeAt(0),l.deleteContents();var t=document.createElement("div");t.innerHTML=e;for(var s=document.createDocumentFragment(),n,o;n=t.firstChild;)o=s.appendChild(n);var d=s.firstChild;l.insertNode(s),o&&(l=l.cloneRange(),l.setStartAfter(o),i?l.setStartBefore(d):l.collapse(!0),a.removeAllRanges(),a.addRange(l))}}else if((a=document.selection)&&"Control"!=a.type){var r=a.createRange();r.collapse(!0),a.createRange().pasteHTML(e),i&&(l=a.createRange(),l.setEndPoint("StartToStart",r),l.select())}}function addMarkdownSyntax(e){return void 0!==e?"!["+e.caption+"]("+UPLOAD_URL+e.name+' "'+e.caption+'")':void 0}function addHTMLSyntax(e){return void 0!==e?'<figure><img src="'+UPLOAD_URL+e.name+'" alt="'+e.caption+'"><figcaption>'+e.caption+"</figcaption></figure>":void 0}function getFileLibrary(){var e={editionId:$("input#EditionId").val()};$.ajax({url:SITE_URL+"/items/file_library",data:e,type:"POST",beforeSend:function(){$("#file-library").html("");var e={lines:10,length:5,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#666",speed:1.7,trail:80,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},i=document.getElementById("file-library"),a=new Spinner(e).spin();i.appendChild(a.el)}}).done(function(e){$("#file-library").fadeOut("fast",function(){fileList={},$("#insert-media").addClass("disabled"),$("#file-library").html(e),$(this).fadeIn("fast")})})}function mediaManager(){if(0!==$("#media-manager").length){var e,i=new Array;$("#upload-files").hide(),$("#insert-media").addClass("disabled");var a=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"select-files",container:"file-uploader",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val()}});a.bind("Init",function(e,i){null!==i.runtime?$("#filelist #runtime-alert").remove():$("#filelist #files").remove()}),a.init(),a.bind("FilesAdded",function(e,i){for(var l in i){var t=i[l],s={fileId:t.id,fileName:t.name,fileSize:plupload.formatSize(t.size)};$.post(SITE_URL+"/items/file_item",s).done(function(e){$("#filelist ul#files").append(e)})}i.length&&$("#upload-files").fadeIn("fast"),$(document).on("click","#file-uploader .remove-file",function(e){var i=$(this).closest(".file").attr("id"),l=a.getFile(i);l&&$(".file#"+i).fadeOut("fast",function(){$(this).remove(),a.removeFile(l)})}),e.refresh()}),a.bind("Error",function(e,i){$("ul#files li#"+i.file.id).remove();var a=i.file?i.file.id:"",l=i.file?i.file.name:"",t={fileId:a,fileName:l,errorCode:i.code,errorMessage:i.message};$.post(SITE_URL+"/items/file_error",t).done(function(e){$("#filelist ul#files").append(e)}),e.refresh()}),a.bind("QueueChanged",function(e,i){0===e.files.length&&$("#upload-files").fadeOut("fast")}),a.bind("FileUploaded",function(e,i,a){$("ul#files li#"+i.id+" .remove-file i").removeClass("fa-times-circle").addClass("fa-check-circle").addClass("text-success"),$("ul#files li#"+i.id+" .remove-file").removeClass("remove-file").addClass("file-success"),$("ul#files li#"+i.id+" .progress").fadeOut("slow")}),a.bind("UploadComplete",function(e,a){$("#upload-files").fadeOut("fast"),"object"===$.type(i)&&(i=[]);for(var l in a){var t=a[l],t={name:t.name,caption:t.name};if(0!==$(".html-editor:visible").length)var s=addHTMLSyntax(t);else var s=addMarkdownSyntax(t);i.push(s)}$("#insert-media").removeClass("disabled")}),a.bind("UploadProgress",function(e,i){$("#filelist ul#files li#"+i.id+" span.progress-bar").width(i.percent+"%").attr("aria-valuenow",i.percent)}),$("#upload-files").on("click",function(e){a.start(),e.preventDefault()}),$("#insert-media").on("click",function(e){if(void 0===i[0]){var a=[];for(var l in i){var t=i[l];if(0!==$(".html-editor:visible").length)var t=addHTMLSyntax(t);else var t=addMarkdownSyntax(t);a.push(t)}var s=a.join("\n")+"\n"}else var s=i.join("\n")+"\n";0!==$(".html-editor:visible").length?insertHTMLAtCursor(s,!1):$("textarea.text-editor:visible").insertAtCaret(s),$("#media-manager").modal("hide"),$(".modal-toggles a").removeClass("disabled")}),$("#media-manager .btn-group a").on("click",function(e){$(this).hasClass("disabled")||($("#media-manager .btn-group a").toggleClass("disabled"),$("#file-uploader, #file-library").toggle(),"toggle-file-library"===$(this).attr("id")?getFileLibrary():$("#insert-media").addClass("disabled")),e.preventDefault()}),$(document).on("click","#file-library a.thumbnail",function(e){var a=$(this).attr("id");if($(e.target).closest(".delete-file").length>0){var l=$(this),t=l.attr("id").substr(5),s={fileId:t,editionId:$("input#EditionId").val()};$.post(SITE_URL+"/items/file_delete",s).done(function(e){l.remove(),null!==i[a]&&delete i[a]})}else if($(e.target).closest(".file-caption").length>0){var n=$(e.target).parents(".thumbnail").attr("id").substr(5),o=$("#file-caption-"+n);o.toggleClass("hidden"),$("#modal-overlay").toggleClass("hidden")}else{if($(this).toggleClass("selected"),$(this).hasClass("selected")){var d={name:$("img",this).attr("data-filename"),caption:$("img",this).attr("alt")};i[a]=d}else null!==i[a]&&delete i[a];void 0!==i&&($.isEmptyObject(i)?$("#insert-media").addClass("disabled"):$("#insert-media").removeClass("disabled"))}e.preventDefault()}),$(document).on("click",".file-caption-form button.close, #modal-overlay",function(e){if(!$(this).hasClass("clicked")){$(this).addClass("clicked");var i=$(".file-caption-form:visible input.file-id").val(),a=$(".file-caption-form:visible textarea").val(),l={fileId:i,editionId:$("input#EditionId").val(),caption:a};$(".file-caption-form:visible").toggleClass("hidden"),$.post(SITE_URL+"/items/file_caption",l).done(function(e){$("#modal-overlay").toggleClass("hidden")})}e.preventDefault()}),$("#media-manager").on("hidden.bs.modal",function(){a.files=[],$("#upload-files").hide(),$("ul#files li").remove(),a.refresh(),i=[],$("#file-library a.thumbnail").removeClass("selected"),$(".modal-toggles a").removeClass("disabled"),0!==$(".html-editor:visible").length&&$(".rich-text-processor").addClass("disabled")}),$("#media-manager").on("show.bs.modal",function(){$("#file-uploader").hide(),getFileLibrary()})}}function coverUploader(){var e=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"cover-image-upload",container:"cover-uploader",drop_element:"cover-image-upload",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val(),type:"cover"}});e.init(),e.bind("FilesAdded",function(e,i){e.start()}),e.bind("UploadComplete",function(e,i){$("#cover-image-upload span.fa-plus").show(""),$("#cover-image-upload .spinner").remove("");var a=$("input#EditionId").val();$.get(SITE_URL+"/editions/get_cover/"+a).done(function(e){$("#cover-image-current").css({"background-image":'url("'+UPLOAD_URL+e+'")'})})}),e.bind("BeforeUpload",function(e,i){var a={lines:11,length:6,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#333",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};$("#cover-image-upload span.fa-plus").hide("");var l=document.getElementById("cover-image-upload"),t=new Spinner(a).spin(l)})}function stylePackageUploader(){var e=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"edition-style-upload",container:"edition-style-select-group",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val(),"package":!0}});e.init(),e.bind("FilesAdded",function(e,i){e.start()}),e.bind("UploadComplete",function(e,i){$("#edition-style-upload").removeClass("disabled"),$("#edition-style-upload span.fa-spinner").removeClass("fa-spinner").removeClass("fa-spin").addClass("fa-cloud-upload");var a=i[0].name,l=a.substr(0,a.lastIndexOf(".zip"));$("#EditionStyle").append('<option name="'+i[0].name+'">'+l+"</option>")}),e.bind("BeforeUpload",function(e,i){$("#edition-style-upload").addClass("disabled"),$("#edition-style-upload span.fa-cloud-upload").removeClass("fa-cloud-upload").addClass("fa-spinner").addClass("fa-spin")})}$(document).ready(function(){mediaManager(),coverUploader(),stylePackageUploader(),$("body").tooltip({selector:"[data-toggle=tooltip]"})});