function addMarkdownSyntax(e){return void 0!==e?"!["+e.caption+"]("+UPLOAD_URL+e.name+' "'+e.caption+'")':void 0}function getFileLibrary(){var e={editionId:$("input#EditionId").val()};$.ajax({url:SITE_URL+"/items/file_library",data:e,type:"POST",beforeSend:function(){$("#file-library").html("");var e={lines:10,length:5,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#666",speed:1.7,trail:80,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},i=document.getElementById("file-library"),l=new Spinner(e).spin();i.appendChild(l.el)}}).done(function(e){$("#file-library").fadeOut("fast",function(){fileList={},$("#insert-media").addClass("disabled"),$("#file-library").html(e),$(this).fadeIn("fast")})})}function mediaManager(){if(0!==$("#media-manager").length){var e,i=new Array;$("#upload-files").hide(),$("#insert-media").addClass("disabled");var l=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"select-files",container:"file-uploader",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",resize:{width:320,height:240,quality:90},flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val()}});l.bind("Init",function(e,i){null!==i.runtime?$("#filelist #runtime-alert").remove():$("#filelist #files").remove()}),l.init(),l.bind("FilesAdded",function(e,i){for(var a in i){var t=i[a],s={fileId:t.id,fileName:t.name,fileSize:plupload.formatSize(t.size)};$.post(SITE_URL+"/items/file_item",s).done(function(e){$("#filelist ul#files").append(e)})}i.length&&$("#upload-files").fadeIn("fast"),$(document).on("click","#file-uploader .remove-file",function(e){var i=$(this).closest(".file").attr("id"),a=l.getFile(i);a&&$(".file#"+i).fadeOut("fast",function(){$(this).remove(),l.removeFile(a)})}),e.refresh()}),l.bind("Error",function(e,i){$("ul#files li#"+i.file.id).remove();var l=i.file?i.file.id:"",a=i.file?i.file.name:"",t={fileId:l,fileName:a,errorCode:i.code,errorMessage:i.message};$.post(SITE_URL+"/items/file_error",t).done(function(e){$("#filelist ul#files").append(e)}),e.refresh()}),l.bind("QueueChanged",function(e,i){0===e.files.length&&$("#upload-files").fadeOut("fast")}),l.bind("FileUploaded",function(e,i,l){$("ul#files li#"+i.id+" .remove-file i").removeClass("fa-times-circle").addClass("fa-check-circle").addClass("text-success"),$("ul#files li#"+i.id+" .remove-file").removeClass("remove-file").addClass("file-success"),$("ul#files li#"+i.id+" .progress").fadeOut("slow")}),l.bind("UploadComplete",function(e,l){$("#upload-files").fadeOut("fast"),"object"===$.type(i)&&(i=[]);for(var a in l){var t=l[a],t={name:t.name,caption:t.name},s=addMarkdownSyntax(t);i.push(s)}$("#insert-media").removeClass("disabled")}),l.bind("UploadProgress",function(e,i){$("#filelist ul#files li#"+i.id+" span.progress-bar").width(i.percent+"%").attr("aria-valuenow",i.percent)}),$("#upload-files").on("click",function(e){l.start(),e.preventDefault()}),$("#insert-media").on("click",function(e){if("object"===$.type(i)){var l=[];for(var a in i){var t=i[a],t=addMarkdownSyntax(t);l.push(t)}var s=l.join("\n")+"\n"}else var s=i.join("\n")+"\n";$("textarea.text-editor:visible").insertAtCaret(s),$("#media-manager").modal("hide"),$("#modal-toggles a").removeClass("disabled")}),$(".btn-group a").on("click",function(e){$(this).hasClass("disabled")||($(".btn-group a").toggleClass("disabled"),$("#file-uploader, #file-library").toggle(),"toggle-file-library"===$(this).attr("id")&&getFileLibrary()),e.preventDefault()}),$(document).on("click","#file-library a.thumbnail",function(e){var l=$(this).attr("id");if($(e.target).closest(".delete-file").length>0){var a=$(this),t=a.attr("id").substr(5),s={fileId:t,editionId:$("input#EditionId").val()};$.post(SITE_URL+"/items/file_delete",s).done(function(e){a.remove(),null!==i[l]&&delete i[l]})}else{if($(this).toggleClass("selected"),$(this).hasClass("selected")){var n={name:$("img",this).attr("data-filename"),caption:$("img",this).attr("alt")};i[l]=n}else null!==i[l]&&delete i[l];void 0!==i&&($.isEmptyObject(i)?$("#insert-media").addClass("disabled"):$("#insert-media").removeClass("disabled"))}e.preventDefault()}),$("#media-manager").on("hidden.bs.modal",function(){l.files=[],$("#upload-files").hide(),$("ul#files li").remove(),l.refresh(),i="",$("#file-library a.thumbnail").removeClass("selected"),$("#modal-toggles a").removeClass("disabled")}),$("#media-manager").on("show.bs.modal",function(){getFileLibrary()})}}function coverUploader(){var e=new plupload.Uploader({runtimes:"html5,gears,flash,silverlight,browserplus",browse_button:"cover-image-upload",container:"cover-uploader",drop_element:"cover-image-upload",max_file_size:"10mb",url:SITE_URL+"/items/file_upload",resize:{width:320,height:240,quality:90},flash_swf_url:SITE_URL+"/assets/plupload/plupload.flash.swf",silverlight_xap_url:SITE_URL+"/assets/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,gif,png"},{title:"Zip files",extensions:"zip"}],multipart_params:{editionId:$("input#EditionId").val(),type:"cover"}});e.init(),e.bind("FilesAdded",function(e,i){e.start()}),e.bind("UploadComplete",function(e,i){$("#cover-image-upload span.fa-plus").show(""),$("#cover-image-upload .spinner").remove("");var l=$("input#EditionId").val();$.get(SITE_URL+"/editions/get_cover/"+l).done(function(e){$("#cover-image-current").css({"background-image":'url("'+UPLOAD_URL+e+'")'})})}),e.bind("BeforeUpload",function(e,i){var l={lines:11,length:6,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#333",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};$("#cover-image-upload span.fa-plus").hide("");var a=document.getElementById("cover-image-upload"),t=new Spinner(l).spin(a)})}$(document).ready(function(){mediaManager(),coverUploader(),$("body").tooltip({selector:"[data-toggle=tooltip]"})});