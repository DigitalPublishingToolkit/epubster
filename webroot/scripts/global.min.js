function slugify(t){return t.toLowerCase().replace(/.xhtml/,"").replace(/[^\w ]+/g,"-").replace(/ +/g,"-")}function sectionTabs(){var t=$.jStorage.get("selected-tab");t&&$('#edition-tabs a[href="'+t+'"]').tab("show");var e=$.jStorage.get("selected-section-tab");e&&$('#section-tabs a[href="'+e+'"]').tab("show"),$(document).on("click",'#edition-tabs a, #section-tabs a[id!="add-new-section"]',function(t){var e=$(this).parents("ul");$(".tab-settings").popover("destroy"),t.preventDefault(),$(this).tab("show"),"section-tabs"===e.attr("id")?$.jStorage.set("selected-section-tab",$(this).attr("href")):$.jStorage.set("selected-tab",$(this).attr("href")),editor&&editor.deactivate(),setupMediumEditor()}),$("#section-tabs a#add-new-section").on("click",function(t){var e=$(this),o=e.attr("href");$.get(o,function(t){var i=$("input.section-title",t).val(),n=slugify(i);$('<li><a href="#section-'+n+'">'+i+"</a>").insertBefore("#section-tabs li:last"),$("#tab-content .tab-content").append(t);var a="#section-"+n;$('#section-tabs a[href="'+a+'"]').tab("show"),editor.deactivate(),setupMediumEditor();var r=o.match(/\d+$/);if(r)var r=parseInt(r[0])+1;var s=o.replace(/\d+$/,r);e.attr("href",s)}),t.preventDefault()}),$("select#EditionChapters").on("change",function(){var t="#section-"+$(this).val();$('#section-tabs a[href="'+t+'"]').tab("show"),editor.deactivate(),setupMediumEditor()}),$('.editions .btn-primary[type="submit"]').on("click",function(t){$(".form-control-feedback").remove(),$(".has-feedback").removeClass("has-success").removeClass("has-error").removeClass("has-feedback");var e=0,o="";if($(":input[required]",".editions form").each(function(t,i){var n=$(this).parents(".form-group");n.addClass("has-feedback"),""==$(this).val()?(n.addClass("has-error").append('<span class="fa fa-ban form-control-feedback"></span>'),0===t&&(o=$(this)),0==e&&$(this).focus(),e=1):n.addClass("has-success").append('<span class="fa fa-check-circle form-control-feedback"></span>')}),1==e){o&&o.focus();var i=o.closest(".tab-pane").attr("id");$('#edition-tabs a[href="#'+i+'"]').tab("show"),$("#form-validation-error").show(),t.preventDefault()}})}function sectionSort(){$("#section-sorting").sortable({placeholder:"ui-state-highlight",stop:function(){var t=[];$("ul#section-sorting li").each(function(e,o){var i=$(o).attr("id").substr(8),n={id:i,order:e+1};t.push(n)});var t=JSON.stringify(t);$("input#EditionSection-order").val(t),$("#section-sorting .section-delete").show(),$("#section-sorting .section-delete:first").hide()}}),$("#section-sorting").disableSelection(),$("#section-sorting .section-delete").on("click",function(t){var e=$(this).attr("id").substr(15),o=$("input#EditionSection-delete").val();if(o)var o=JSON.parse(o);else var o=[];o.push(e);var o=JSON.stringify(o);$("input#EditionSection-delete").val(o),$(this).parent().fadeOut("fast",function(){$(this).remove()}),t.preventDefault()})}function generateEdition(){$("#generate-epub").on("click",function(t){var e=$("#EditionId").val();generateEPUB(e,!0),t.preventDefault()})}function generateEPUB(t,e){$.ajax({url:SITE_URL+"editions/generate/"+t,beforeSend:function(){var t={lines:11,length:6,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#333",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};if(e)$("#epub-generator-overlay").fadeIn("fast"),$("body, html").css("overflow","hidden");else var o=new Spinner(t).spin(i),i=document.getElementById("epub-container")},success:function(t){t&&(e?(epub=t+".epub",window.location.replace(epub),$("#epub-generator-overlay").fadeOut("fast",function(){$("body, html").css("overflow","auto")})):$("#epub-container").fadeOut("fast",function(){epub=t+".epub",$(this).html("").append('<iframe id="page-epub" src="'+SITE_URL+'/assets/epub-js/epub-js.html"></iframe>').fadeIn("fast")}))}})}function cleanFootnote(t){return void 0!==t?t.replace(/\[\^](.*?)\]/,function(t,e){return e}):void 0}function Person(){rangy.init(),this.button=document.createElement("button"),this.button.className="medium-editor-action",this.button.innerHTML='<i class="fa fa-user"></i>',this.button.onclick=this.onClick.bind(this),this.classApplier=rangy.createCssClassApplier("is-person",{elementTagName:"span",normalize:!0})}function Index(){rangy.init(),this.button=document.createElement("button"),this.button.className="medium-editor-action",this.button.innerHTML='<i class="fa fa-thumb-tack"></i>',this.button.onclick=this.onClick.bind(this),this.classApplier=rangy.createCssClassApplier("is-highlight",{elementTagName:"span",normalize:!0})}function Notes(){this.button=document.createElement("button"),this.button.className="medium-editor-action",this.button.innerHTML='<i class="fa fa-comment"></i>',this.button.onclick=this.onClick.bind(this),0===$(".medium-editor-footnote-preview").length&&$("body").append('<div id="medium-editor-footnote-preview-container" class="medium-editor-anchor-preview medium-toolbar-arrow-over" style="top: 973px; left: 632.5px;"><div class="medium-editor-toolbar-anchor-preview" id="medium-editor-toolbar-footnote-preview"><span class="medium-editor-toolbar-footnote-preview-inner"></span></div></div>')}function previewFootnote(){$(document).on("mouseenter mouseleave",".has-footnote",function(t){var e=$("#medium-editor-footnote-preview-container"),o=cleanFootnote($(".inline-footnote-content",this).html());if("mouseenter"===t.type){e.addClass("medium-editor-anchor-preview-active"),$("#medium-editor-toolbar-footnote-preview .medium-editor-toolbar-footnote-preview-inner").append('<span class="footnote-preview">'+o+"</span>");var i=$(this).offset();e.css({top:i.top-(e.height()+$(this).height())+100,left:i.left-(e.width()-$(this).width())/2})}else e.removeClass("medium-editor-anchor-preview-active"),$("#medium-editor-toolbar-footnote-preview .medium-editor-toolbar-footnote-preview-inner span.footnote-preview").remove()})}function saveSelection(){var t,e,o,i=window.getSelection();if(i.getRangeAt&&i.rangeCount){for(o=[],t=0,e=i.rangeCount;e>t;t+=1)o.push(i.getRangeAt(t));return o}return null}function restoreSelection(t){var e,o,i=window.getSelection();if(t)for(i.removeAllRanges(),e=0,o=t.length;o>e;e+=1)i.addRange(t[e])}function setupMediumEditor(){editor=new MediumEditor(".html-editor",{buttons:["bold","italic","quote","link","anchor","orderedlist","unorderedlist","header1","header2","note","index","person"],buttonLabels:"fontawesome",forcePlainText:!1,placeholder:"Start writing the content of this section...",extensions:{note:new Notes,index:new Index,person:new Person}})}function copyTextfield(){$(".html-editor").each(function(t,e){$(".inline-footnote-content").show();var o=$(e).attr("id").substr(7),i=$(e).html().trim();$("#textarea-"+o).html(i)})}function setupEditors(){var t=$.jStorage.get("current-editor");"plain-text"===t&&($(".wysiwyg, .plain-text, .plain-text-editor, .html-editor").toggleClass("hidden"),$(".rich-text-processor").toggleClass("disabled"),$(".btn-primary").off()),"wysiwyg"===t&&(setupMediumEditor(),$("body").on("click",".btn-primary",copyTextfield)),$(".wysiwyg, .plain-text").on("click",function(t){$(".wysiwyg, .plain-text, .plain-text-editor, .html-editor").toggleClass("hidden"),$(".rich-text-processor").toggleClass("disabled"),$(this).hasClass("wysiwyg")?(void 0===editor?setupMediumEditor():editor.activate(),$.jStorage.set("current-editor","wysiwyg"),$("body").on("click",".btn-primary",copyTextfield)):(copyTextfield(),editor.deactivate(),$.jStorage.set("current-editor","plain-text"),$("body").off("click",".btn-primary",copyTextfield)),t.preventDefault()})}var epub,editor,savedSelection,footnote,footnoteValue;$.fn.extend({insertAtCaret:function(t){return this.each(function(e){if(document.selection){this.focus();var o=document.selection.createRange();o.text=t,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var i=this.selectionStart,n=this.selectionEnd,a=this.scrollTop;this.value=this.value.substring(0,i)+t+this.value.substring(n,this.value.length),this.focus(),this.selectionStart=i+t.length,this.selectionEnd=i+t.length,this.scrollTop=a}else this.value+=t,this.focus()})}}),$(":not(#anything)").on("click",function(t){$(".tab-settings").each(function(){return $(this).is(t.target)||0!==$(this).has(t.target).length||0!==$(".popover").has(t.target).length?void 0:void $(this).popover("hide")})}),Person.prototype.onClick=function(t){this.classApplier.toggleSelection()},Person.prototype.getButton=function(){return this.button},Person.prototype.checkState=function(t){var t=$(t);t.hasClass("is-person")&&this.button.classList.add("medium-editor-button-active")},Index.prototype.onClick=function(t){this.classApplier.toggleSelection()},Index.prototype.getButton=function(){return this.button},Index.prototype.checkState=function(t){var t=$(t);t.hasClass("is-highlight")&&this.button.classList.add("medium-editor-button-active")},Notes.prototype.onClick=function(t){0===$(".medium-editor-toolbar-form-note").length&&($(".medium-editor-toolbar").append('<div class="medium-editor-toolbar-form-note"><div class="medium-editor-toolbar-form-note-input" contenteditable=true></div><textarea class="hidden"></textarea><a class="toolbar-close" href="#">Ã—</a> <a class="toolbar-done" href="#"><span class="fa fa-check"></span></a></div>'),""==$(".medium-editor-toolbar-form-note-input").html()&&""!==footnoteValue&&$(".medium-editor-toolbar-form-note-input").html(footnoteValue)),savedSelection=saveSelection(),editor.toolbarActions.style.display="none",$(".medium-editor-toolbar-form-note").show(),editor.keepToolbarAlive=!0,$(".medium-editor-toolbar-form-note-input").focus(),$(".medium-editor-toolbar-form-note a").on("click",function(t){if(!$(this).hasClass("toolbar-done")){t.preventDefault(),editor.showToolbarActions(),$(".medium-editor-toolbar-form-note").hide(),$(".medium-editor-toolbar-form-note-input").html(""),restoreSelection(savedSelection);var e=document.getSelection().anchorNode.parentNode;if($(e).hasClass("has-footnote")){var o=document.getSelection().anchorNode.nodeValue;e.remove(),document.execCommand("insertText",!1,o)}}}),$(".medium-editor-toolbar-form-note a.toolbar-done").on("click",function(t){var e=$(".medium-editor-toolbar-form-note-input").html();$(".medium-editor-toolbar-form-note-input textarea").html(e),t.preventDefault(),$(footnote).remove(),restoreSelection(savedSelection);var o=e;if(o){insertHTMLAtCursor('<span class="has-footnote">'+document.getSelection()+'<span class="inline-footnote-content">[^] '+o+"]</span></span>",!1);var i=$(".has-footnote .has-footnote");0!==i.length&&$(".has-footnote .has-footnote").each(function(t,e){$(this).parent().replaceWith($(this))})}editor.hideToolbarActions(),$(".medium-editor-toolbar-form-note").hide(),$(".medium-editor-toolbar-form-note-input").html("")})},Notes.prototype.getButton=function(){return this.button},Notes.prototype.checkState=function(t){var t=$(t);t.hasClass("has-footnote")&&((void 0===footnote||null===footnote||""===footnote)&&(footnote=$(".inline-footnote-content",t)),footnoteValue=$(".inline-footnote-content",t).first().html(),footnoteValue=cleanFootnote(footnoteValue),$(".medium-editor-toolbar-form-note-input").html(footnoteValue),this.button.classList.add("medium-editor-button-active"))},$(document).ready(function(){setupEditors(),sectionTabs(),sectionSort(),previewFootnote(),generateEdition(),$("body").popover({selector:'[rel="popover"]',html:!0})});
//# sourceMappingURL=./global.min.js.map