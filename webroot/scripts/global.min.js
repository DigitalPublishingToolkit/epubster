function slugify(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}function sectionTabs(){var t=$.jStorage.get("selected-tab");t&&$('#edition-tabs a[href="'+t+'"]').tab("show"),$(document).on("click",'#edition-tabs a, #section-tabs a[id!="add-new-section"]',function(t){$(".tab-settings").popover("destroy"),t.preventDefault(),$(this).tab("show"),$.jStorage.set("selected-tab",$(this).attr("href"))}),$("#section-tabs a#add-new-section").on("click",function(t){var e=$(this),i=e.attr("href");$.get(i,function(t){var n=$("input.section-title",t).val(),s=slugify(n);$('<li><a href="#section-'+s+'">'+n+"</a>").insertBefore("#section-tabs li:last"),$("#tab-content .tab-content").append(t),$('#section-tabs a[href="#section-'+s+'"]').tab("show");var o=i.match(/\d+$/);if(o)var o=parseInt(o[0])+1;var a=i.replace(/\d+$/,o);e.attr("href",a)}),t.preventDefault()}),$("select#EditionChapters").on("change",function(){var t="#section-"+$(this).val();$('#section-tabs a[href="'+t+'"]').tab("show")})}function sectionSort(){$("#section-sorting").sortable({placeholder:"ui-state-highlight",stop:function(){var t=[];$("ul#section-sorting li").each(function(e,i){var n=$(i).attr("id").substr(8),s={id:n,order:e+1};t.push(s)});var t=JSON.stringify(t);$("input#EditionSection-order").val(t),$("#section-sorting .section-delete").show(),$("#section-sorting .section-delete:first").hide()}}),$("#section-sorting").disableSelection(),$("#section-sorting .section-delete").on("click",function(t){var e=$(this).attr("id").substr(15),i=$("input#EditionSection-delete").val();if(i)var i=JSON.parse(i);else var i=[];i.push(e);var i=JSON.stringify(i);$("input#EditionSection-delete").val(i),$(this).parent().fadeOut("fast",function(){$(this).remove()}),t.preventDefault()})}function generateEPUB(t){$.ajax({url:SITE_URL+"editions/generate/"+t,beforeSend:function(){var t={lines:11,length:6,width:2,radius:5,corners:1,rotate:0,direction:1,color:"#333",speed:1,trail:60,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},e=document.getElementById("epub-container"),i=new Spinner(t).spin(e)},success:function(t){t&&$("#epub-container").fadeOut("fast",function(){epub=t+".epub",$(this).html("").append('<iframe id="page-epub" src="'+SITE_URL+'/assets/epub-js/epub-js.html"></iframe>').fadeIn("fast")})}})}var epub;$.fn.extend({insertAtCaret:function(t){return this.each(function(e){if(document.selection){this.focus();var i=document.selection.createRange();i.text=t,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var n=this.selectionStart,s=this.selectionEnd,o=this.scrollTop;this.value=this.value.substring(0,n)+t+this.value.substring(s,this.value.length),this.focus(),this.selectionStart=n+t.length,this.selectionEnd=n+t.length,this.scrollTop=o}else this.value+=t,this.focus()})}}),$(":not(#anything)").on("click",function(t){$(".tab-settings").each(function(){return $(this).is(t.target)||0!==$(this).has(t.target).length||0!==$(".popover").has(t.target).length?void 0:void $(this).popover("hide")})}),$(document).ready(function(){$(".markdown-editor").markItUp(mySettings),sectionTabs(),sectionSort(),$("body").popover({selector:'[rel="popover"]',html:!0})});